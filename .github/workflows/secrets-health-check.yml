name: Secrets And Health Check

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Install clients (psql, lftp, curl)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client lftp curl

      - name: Validate required secrets presence
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BACKEND_URL_PROD: ${{ secrets.BACKEND_URL_PROD }}
          BACKEND_URL_FLY: ${{ secrets.BACKEND_URL_FLY }}
          AI_URL_FLY: ${{ secrets.AI_URL_FLY }}
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_REMOTE_PATH: ${{ secrets.SFTP_REMOTE_PATH }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
        run: |
          missing=0
          check() { v=$1; name=$2; if [ -z "$v" ]; then echo "❌ Missing secret: $name"; missing=1; else echo "✅ Present: $name"; fi }
          check "$DATABASE_URL" DATABASE_URL
          check "$AI_URL_FLY" AI_URL_FLY
          check "$SFTP_HOST" SFTP_HOST
          check "$SFTP_USERNAME" SFTP_USERNAME
          check "$SFTP_PASSWORD" SFTP_PASSWORD
          check "$SFTP_REMOTE_PATH" SFTP_REMOTE_PATH
          check "${SFTP_PORT:-22}" SFTP_PORT
          # At least one backend URL
          if [ -z "$BACKEND_URL_PROD" ] && [ -z "$BACKEND_URL_FLY" ]; then echo "❌ Missing BACKEND_URL_PROD or BACKEND_URL_FLY"; missing=1; else echo "✅ Backend URL provided"; fi
          if [ $missing -ne 0 ]; then exit 1; fi

      - name: Test database connectivity
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          psql "$DATABASE_URL" -c "SELECT NOW();"

      - name: Test backend health
        env:
          URL1: ${{ secrets.BACKEND_URL_PROD }}
          URL2: ${{ secrets.BACKEND_URL_FLY }}
        run: |
          URL=${URL1:-$URL2}
          echo "Checking backend: $URL/health"
          for i in {1..5}; do
            if curl -sf "$URL/health"; then echo "✅ Backend healthy"; exit 0; fi
            sleep 2;
          done
          echo "❌ Backend not healthy"; exit 1

      - name: Test AI Engine Health
        env:
          AI_URL: ${{ secrets.AI_URL_FLY }}
        run: |
          echo "Testing AI Engine..."
          for i in {1..3}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$AI_URL/health")
            if [ "$STATUS" = "200" ]; then
              echo "✅ AI Engine healthy"
              exit 0
            fi
            echo "Retrying ($i/3)..."
            sleep 5
          done
          echo "❌ AI Engine not responding"; exit 1

      - name: Test SFTP connectivity and listing
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_REMOTE_PATH: ${{ secrets.SFTP_REMOTE_PATH }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
        run: |
          PORT=${SFTP_PORT:-22}
          echo "Connecting to sftp://$SFTP_HOST:$PORT ..."
          lftp -u "$SFTP_USERNAME","$SFTP_PASSWORD" -p "$PORT" sftp://"$SFTP_HOST" -e "cd $SFTP_REMOTE_PATH; cls -1; bye"

