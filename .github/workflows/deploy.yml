name: Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  lint-test-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Backend setup (Node)
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - name: Backend lint + test + build
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/btpgo?schema=public
        run: |
          npm ci || npm install
          npx prisma generate
          npm run lint --if-present
          npm test --if-present || echo "no backend tests"
          npm run build

      - name: Frontend setup (Node)
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - name: Frontend test + build
        working-directory: frontend
        run: |
          npm ci || npm install
          echo "VITE_API_URL=http://localhost:3000" > .env
          npm test --if-present || echo "no frontend tests"
          npm run build

      - name: AI Engine setup (Python)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: AI Engine test
        working-directory: ai_engine
        run: |
          pip install -r requirements.txt
          pytest -q || echo "no ai_engine tests"

      - name: Build Docker images
        run: |
          docker build -t btpgo-backend ./backend
          docker build -t btpgo-frontend ./frontend
          docker build -t btpgo-ai ./ai_engine

  security-scan:
    runs-on: ubuntu-latest
    needs: lint-test-build
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Build images for scan
        run: |
          docker build -t btpgo-backend ./BTPGo-IA-Suite/backend
          docker build -t btpgo-frontend ./BTPGo-IA-Suite/frontend
          docker build -t btpgo-ai ./BTPGo-IA-Suite/ai_engine
      - name: Trivy scan backend (table, non-blocking)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'btpgo-backend'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
      - name: Trivy scan backend (json)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'btpgo-backend'
          format: 'json'
          output: 'trivy-backend.json'
      - name: Trivy scan frontend (table, non-blocking)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'btpgo-frontend'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
      - name: Trivy scan frontend (json)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'btpgo-frontend'
          format: 'json'
          output: 'trivy-frontend.json'
      - name: Trivy scan ai_engine (table, non-blocking)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'btpgo-ai'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
      - name: Trivy scan ai_engine (json)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'btpgo-ai'
          format: 'json'
          output: 'trivy-ai.json'
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy-backend.json
            trivy-frontend.json
            trivy-ai.json

  deploy:
    runs-on: ubuntu-latest
    needs: lint-test-build
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - name: Read app name from fly.toml
        id: app
        run: |
          APP=$(awk -F '"' '/^app\s*=/{print $2}' infra/fly.toml)
          echo "app=$APP" >> $GITHUB_OUTPUT
          echo "APP=$APP" >> $GITHUB_ENV
      - name: Ensure Fly app exists
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          set -e
          if ! flyctl apps list | awk '{print $1}' | grep -qx "$APP"; then
            echo "Creating Fly app $APP";
            flyctl apps create "$APP";
          else
            echo "Fly app $APP already exists";
          fi
      - name: Deploy Backend to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          set -e
          flyctl deploy --remote-only --config infra/fly.toml || (echo "::error::Fly deploy failed"; flyctl status --app "$APP" || true; exit 1)
      - name: Health check (backend)
        run: |
          echo "App: $APP"
          for i in {1..40}; do
            curl -fsS https://$APP.fly.dev/health && exit 0 || sleep 10;
          done
          echo "Health check failed" && exit 1
      - name: Build Frontend
        working-directory: frontend
        run: |
          echo "VITE_API_URL=https://api.msmarrakech.com" > .env
          npm ci || npm install
          npm run build
      - name: SFTP secrets check
        run: |
          ok=true
          if [ -z "${{ secrets.SFTP_HOST }}" ] || [ -z "${{ secrets.SFTP_USER }}" ] || [ -z "${{ secrets.SFTP_PASS }}" ]; then
            echo "::warning::SFTP secrets missing (SFTP_HOST/USER/PASS). Skipping SFTP deploy."
            ok=false
          fi
          echo "SFTP_OK=$ok" >> $GITHUB_ENV

      - name: SFTP Deploy Frontend
        if: ${{ env.SFTP_OK == 'true' }}
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          local_path: frontend/dist/*
          remote_path: ${{ secrets.SFTP_PATH || '/public_html' }}
