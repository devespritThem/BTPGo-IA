name: Deploy Frontend to o2switch (SFTP)

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend-o2switch.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SFTP_PORT_VALUE: ${{ secrets.SFTP_PORT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build Frontend
        working-directory: frontend
        env:
          VITE_API_URL: ${{ secrets.BACKEND_URL_PROD }}
        run: |
          npm ci || npm install
          npm run build

      - name: Ensure SPA fallback (.htaccess)
        working-directory: frontend/dist
        run: |
          set -eu
          # Write stable SPA .htaccess for BrowserRouter
          cat > .htaccess << 'HTACCESS'
          RewriteEngine On
          RewriteBase /
          # If the request is for an existing file or directory, serve it
          RewriteCond %{REQUEST_FILENAME} -f [OR]
          RewriteCond %{REQUEST_FILENAME} -d
          RewriteRule ^ - [L]
          # Otherwise, serve index.html (SPA fallback)
          RewriteRule . /index.html [L]
          HTACCESS

      - name: Deploy dist via FTPS (explicit) to primary path
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          protocol: ftps
          port: ${{ env.SFTP_PORT_VALUE != '' && env.SFTP_PORT_VALUE || '21' }}
          local-dir: frontend/dist/
          server-dir: ${{ secrets.SFTP_REMOTE_PATH }}/
          timeout: 600000
          state-name: .ftp-deploy-sync-state.json
          dangerous-clean-slate: true

      - name: Purge Cloudflare cache (optional)
        env:
          CF_ZONE: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -n "$CF_ZONE" ] && [ -n "$CF_TOKEN" ]; then
            echo "Purging Cloudflare cache for zone $CF_ZONE";
            curl -fsSL -X POST \
              -H "Authorization: Bearer $CF_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}' \
              "https://api.cloudflare.com/client/v4/zones/$CF_ZONE/purge_cache";
          else
            echo "Skipping Cloudflare purge (missing CF env vars)";
          fi

      - name: Verify deep links (HashRouter)
        env:
          FRONTEND_URL: ${{ secrets.FRONTEND_URL_PROD }}
        run: |
          if [ -z "$FRONTEND_URL" ]; then echo "FRONTEND_URL_PROD secret missing"; exit 1; fi
          echo "Checking deep links on $FRONTEND_URL"
          for path in '//login' '//demo'; do
            url="$FRONTEND_URL$path"
            code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            echo "$url -> $code"
            if [ "$code" != "200" ]; then
              echo "Deep link $url did not return 200"; exit 1;
            fi
          done

