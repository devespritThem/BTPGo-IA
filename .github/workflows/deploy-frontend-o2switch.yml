name: Deploy Frontend to o2switch (SFTP)

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend-o2switch.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build Frontend
        working-directory: frontend
        env:
          VITE_API_URL: ${{ secrets.BACKEND_URL_PROD }}
        run: |
          npm ci || npm install
          npm run build

      - name: Ensure deep-link redirects exist (/login, /demo)
        working-directory: frontend/dist
        run: |
          set -eu
          mkdir -p login demo
          cat > login/index.html << 'HTML'
          <!doctype html>
          <html lang="fr">
            <head>
              <meta charset="UTF-8" />
              <meta http-equiv="refresh" content="0; url=/#/login">
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Redirection vers /#/login</title>
              <script>
                (function(){try{var qs=location.search||'';location.replace('/#/login'+(qs||''));}catch(_){location.href='/#/login';}})();
              </script>
            </head>
            <body>Redirection vers <a href="/#/login">/#/login</a>...</body>
          </html>
          HTML
          cat > demo/index.html << 'HTML'
          <!doctype html>
          <html lang="fr">
            <head>
              <meta charset="UTF-8" />
              <meta http-equiv="refresh" content="0; url=/#/demo">
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Redirection vers /#/demo</title>
              <script>
                (function(){try{var qs=location.search||'';location.replace('/#/demo'+(qs||''));}catch(_){location.href='/#/demo';}})();
              </script>
            </head>
            <body>Redirection vers <a href="/#/demo">/#/demo</a>...</body>
          </html>
          HTML
          # Create minimal .htaccess fallback if missing
          if [ ! -f .htaccess ]; then
            printf '%s
FallbackResource /index.html
' "Options -Indexes -MultiViews" > .htaccess
          fi

      - name: Deploy dist via FTPS (explicit) to primary path
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          protocol: ftps
          port: ${{ secrets.SFTP_PORT || 21 }}
          local-dir: frontend/dist/
          server-dir: ${{ secrets.SFTP_REMOTE_PATH }}/
          timeout: 600000
          state-name: .ftp-deploy-sync-state.json
          dangerous-clean-slate: true

      - name: Deploy dist via FTPS (explicit) to public_html fallback
        if: ${{ always() }}
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          protocol: ftps
          port: ${{ secrets.SFTP_PORT || 21 }}
          local-dir: frontend/dist/
          server-dir: public_html/
          timeout: 600000
          state-name: .ftp-deploy-sync-state-public_html.json
          dangerous-clean-slate: false

      - name: Purge Cloudflare cache (optional)
        env:
          CF_ZONE: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -n "$CF_ZONE" ] && [ -n "$CF_TOKEN" ]; then
            echo "Purging Cloudflare cache for zone $CF_ZONE";
            curl -fsSL -X POST \
              -H "Authorization: Bearer $CF_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}' \
              "https://api.cloudflare.com/client/v4/zones/$CF_ZONE/purge_cache";
          else
            echo "Skipping Cloudflare purge (missing CF env vars)";
          fi

      - name: Verify deep links (HashRouter)
        env:
          FRONTEND_URL: ${{ secrets.FRONTEND_URL_PROD }}
        run: |
          if [ -z "$FRONTEND_URL" ]; then echo "FRONTEND_URL_PROD secret missing"; exit 1; fi
          echo "Checking deep links on $FRONTEND_URL"
          for path in '//login' '//demo'; do
            url="$FRONTEND_URL$path"
            code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            echo "$url -> $code"
            if [ "$code" != "200" ]; then
              echo "Deep link $url did not return 200"; exit 1;
            fi
          done

