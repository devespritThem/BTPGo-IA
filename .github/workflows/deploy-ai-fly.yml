name: Deploy AI Engine (Fly)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'ai_engine/**'
      - '.github/workflows/deploy-ai-fly.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FLY_AI_APP: ${{ secrets.FLY_AI_APP || 'btpgo-ai' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Set AI secrets (optional)
        if: ${{ secrets.FLY_API_TOKEN != '' }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_EXPORTER_OTLP_ENDPOINT }}
        run: |
          ARGS=()
          [ -n "$OTEL_EXPORTER_OTLP_ENDPOINT" ] && ARGS+=(OTEL_EXPORTER_OTLP_ENDPOINT="$OTEL_EXPORTER_OTLP_ENDPOINT")
          if [ ${#ARGS[@]} -gt 0 ]; then flyctl secrets set "${ARGS[@]}" --app "${{ env.FLY_AI_APP }}"; else echo "No AI secrets to set"; fi

      - name: Deploy AI Engine (ai_engine/fly.toml)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --remote-only --config ai_engine/fly.toml --app "${{ env.FLY_AI_APP }}"
