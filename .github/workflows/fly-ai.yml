name: Fly Deploy - AI Engine

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'ai_engine/**'
      - '.github/workflows/fly-ai.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FLY_AI_APP: ${{ secrets.FLY_AI_APP || 'btpgo-ai' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Deploy AI Engine
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          cd ai_engine
          flyctl deploy --remote-only --config fly.toml --app "${{ env.FLY_AI_APP }}"

      - name: Wait for AI health (Fly URL)
        if: ${{ secrets.AI_URL_FLY != '' }}
        env:
          URL: ${{ secrets.AI_URL_FLY }}
        run: |
          for i in {1..60}; do
            if curl -sf "$URL/" >/dev/null; then echo "ai healthy"; exit 0; fi
            sleep 2;
          done
          echo "AI not healthy at $URL/"; exit 1

      - name: Check AI metrics endpoint
        if: ${{ secrets.AI_URL_FLY != '' }}
        env:
          URL: ${{ secrets.AI_URL_FLY }}
        run: |
          curl -sf "$URL/metrics" | head -n 5 || exit 1
