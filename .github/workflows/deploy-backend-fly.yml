name: Deploy Backend (Fly)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      FLY_BACKEND_APP: ${{ secrets.FLY_BACKEND_APP || 'btpgo-api' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Set secrets on Fly
        if: ${{ secrets.FLY_API_TOKEN != '' }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          DATA_ENCRYPTION_KEY: ${{ secrets.DATA_ENCRYPTION_KEY }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL_PROD }}
          CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
          CORS_ALLOWED_METHODS: ${{ secrets.CORS_ALLOWED_METHODS }}
          CORS_ALLOWED_HEADERS: ${{ secrets.CORS_ALLOWED_HEADERS }}
          CORS_EXPOSED_HEADERS: ${{ secrets.CORS_EXPOSED_HEADERS }}
        run: |
          ARGS=()
          [ -n "$DATABASE_URL" ] && ARGS+=(DATABASE_URL="$DATABASE_URL")
          [ -n "$JWT_SECRET" ] && ARGS+=(JWT_SECRET="$JWT_SECRET")
          [ -n "$DATA_ENCRYPTION_KEY" ] && ARGS+=(DATA_ENCRYPTION_KEY="$DATA_ENCRYPTION_KEY")
          [ -n "$FRONTEND_URL" ] && ARGS+=(FRONTEND_URL="$FRONTEND_URL")
          [ -n "$CORS_ORIGINS" ] && ARGS+=(CORS_ORIGINS="$CORS_ORIGINS")
          [ -n "$CORS_ALLOWED_METHODS" ] && ARGS+=(CORS_ALLOWED_METHODS="$CORS_ALLOWED_METHODS")
          [ -n "$CORS_ALLOWED_HEADERS" ] && ARGS+=(CORS_ALLOWED_HEADERS="$CORS_ALLOWED_HEADERS")
          [ -n "$CORS_EXPOSED_HEADERS" ] && ARGS+=(CORS_EXPOSED_HEADERS="$CORS_EXPOSED_HEADERS")
          if [ ${#ARGS[@]} -eq 0 ]; then echo "No secrets to set"; exit 0; fi
          flyctl secrets set "${ARGS[@]}" --app "${{ env.FLY_BACKEND_APP }}"

      - name: Deploy Backend (root fly.toml)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --remote-only --config fly.toml --app "${{ env.FLY_BACKEND_APP }}"

      - name: Wait for health
        if: ${{ secrets.BACKEND_URL_FLY != '' }}
        env:
          URL: ${{ secrets.BACKEND_URL_FLY }}
        run: |
          for i in {1..60}; do
            if curl -sf "$URL/health" >/dev/null; then echo "healthy"; exit 0; fi
            sleep 2;
          done
          echo "Backend not healthy at $URL/health"; exit 1

      - name: Smoke test
        if: ${{ secrets.BACKEND_URL_FLY != '' }}
        working-directory: backend
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL_FLY }}
        run: |
          npm ci --omit=dev || npm install --omit=dev
          node scripts/smoke.js
