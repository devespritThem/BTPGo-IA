name: Fly Deploy - Backend

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/fly-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Set secrets on Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          DATA_ENCRYPTION_KEY: ${{ secrets.DATA_ENCRYPTION_KEY }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL_PROD }}
        run: |
          flyctl secrets set \
            DATABASE_URL="$DATABASE_URL" \
            JWT_SECRET="$JWT_SECRET" \
            DATA_ENCRYPTION_KEY="$DATA_ENCRYPTION_KEY" \
            FRONTEND_URL="$FRONTEND_URL" \
            MIGRATE_ON_START="true" \
            SEED="false" \
            --app btpgo-backend

      - name: Deploy Backend
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          cd backend
          flyctl deploy --remote-only --config fly.toml --app btpgo-backend

      - name: Setup Node for smoke
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install backend deps (for smoke)
        working-directory: backend
        run: npm ci || npm install

      - name: Wait for backend health (Fly URL)
        if: ${{ secrets.BACKEND_URL_FLY != '' }}
        env:
          URL: ${{ secrets.BACKEND_URL_FLY }}
        run: |
          for i in {1..60}; do
            if curl -sf "$URL/health" >/dev/null; then echo "healthy"; exit 0; fi
            sleep 2;
          done
          echo "Backend not healthy at $URL/health"; exit 1

      - name: Smoke test against Fly URL
        if: ${{ secrets.BACKEND_URL_FLY != '' }}
        working-directory: backend
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL_FLY }}
        run: npm run smoke

      - name: Check Frontend URL (optional)
        if: ${{ secrets.FRONTEND_URL_PROD != '' }}
        env:
          URL: ${{ secrets.FRONTEND_URL_PROD }}
        run: |
          echo "Checking frontend at $URL"
          curl -sSf "$URL" -o /dev/null
